# actvalue.mysql-redis-cache

Async wrapper for MySQL queries with Redis caching for Python 3.13+.

## Installation

```bash
pip install actvalue.mysql-redis-cache
```

Using uv:
```bash
uv add actvalue.mysql-redis-cache
```

## Quick Start

### Client Usage

```python
from mysql_redis_cache import MRCClient

mysql_config = {
    'host': 'localhost',
    'port': 3306,
    'user': 'myuser',
    'password': 'mypassword',
    'db': 'mydatabase',
}

redis_config = {
    'host': 'localhost',
    'port': 6379,
    'password': 'mypassword',
}

# Using context manager (recommended)
async with MRCClient(mysql_config, redis_config) as client:
    # Execute query with caching
    query = 'SELECT * FROM users WHERE id = ?'
    params = [123]
    param_names = ['UserId']
    ttl = 3600  # 1 hour
    
    result = await client.query_with_cache(query, params, param_names, ttl)

# Or manual connection management
client = MRCClient(mysql_config, redis_config)
result = await client.query_with_cache(query, params, param_names, ttl)
await client.close_redis_connection()
```

### Server Usage (Cache Invalidation)

```python
from mysql_redis_cache import MRCServer

redis_config = {
    'host': 'localhost',
    'port': 6379,
    'password': 'mypassword',
}

async with MRCServer(redis_config) as server:
    # Delete all cached queries with StoreId = 6
    deleted_count = await server.drop_outdated_cache(['StoreId'], [6])
    print(f"Deleted {deleted_count} cache entries")
```

### Caching Arbitrary Functions

```python
async def expensive_computation(x: int, y: int) -> int:
    # Some expensive operation
    await asyncio.sleep(2)
    return x * y

# Cache the function result
result = await client.with_cache(
    fn=lambda: expensive_computation(10, 20),
    query='expensive_computation_v1',  # Signature for cache key
    params=[10, 20],
    param_names=['x', 'y'],
    ttl=3600
)
```

## Configuration

### MySQL Configuration

**Option 1: Dictionary**
```python
mysql_config = {
    'host': 'localhost',
    'port': 3306,
    'user': 'myuser',
    'password': 'mypassword',
    'db': 'mydatabase',
    'minsize': 1,    # Connection pool minimum size
    'maxsize': 10,   # Connection pool maximum size
}
```

**Option 2: Connection String**
```python
mysql_config = 'mysql://user:password@localhost:3306/database'
```

### Redis Configuration

```python
redis_config = {
    'host': 'localhost',
    'port': 6379,
    'password': 'mypassword',
    'username': 'default',
    'decode_responses': False,  # Important: keep binary for JSON storage
    'socket_connect_timeout': 30,
}
```

## API Reference

### MRCClient

#### Methods

- `async __init__(mysql_config, redis_config=None)` - Initialize client
- `async __aenter__()` - Context manager entry - connect to services
- `async __aexit__(exc_type, exc_val, exc_tb)` - Context manager exit - cleanup
- `async query_with_cache(query, params=None, param_names=[], ttl=86400)` - Execute MySQL query with caching
- `async with_cache(fn, query, params=None, param_names=[], ttl=86400)` - Execute arbitrary async function with caching
- `async read_from_cache(query, params=None, param_names=[])` - Read cached query result
- `async write_to_cache(query, value, params=None, param_names=[], ttl=86400)` - Write query result to cache
- `get_key_from_query(query, params=None, param_names=[])` - Generate cache key
- `async query_to_promise(query, params=None)` - Execute MySQL query without caching
- `get_mysql_pool()` - Get MySQL connection pool for direct access
- `async close_redis_connection()` - Close Redis connection

### MRCServer

#### Methods

- `async __init__(redis_config)` - Initialize server
- `async __aenter__()` - Context manager entry
- `async __aexit__(exc_type, exc_val, exc_tb)` - Context manager exit
- `async drop_outdated_cache(key_names, key_values)` - Delete cached queries matching key patterns
- `async close_redis_connection()` - Close Redis connection

## Cache Key Format

Cache keys are generated using the format:
```
{param_name1}={value1}_{param_name2}={value2}_{SHA1_hash}
```

Examples:
- No params: `{SHA1_hash}`
- With params: `UserId=123_StoreId=456_{SHA1_hash}`

## TTL Jitter

To prevent thundering herd problems, TTL values have a Â±10% random jitter applied:
```python
actual_ttl = ttl + round(ttl * random.uniform(-0.1, 0.1))
```

## Cross-Platform Compatibility

This Python implementation is fully compatible with the TypeScript version:
- Cache keys generated by Python match TypeScript exactly
- JSON serialization format is identical
- Both implementations can read each other's cached data
- MySQL data types are handled consistently

## Development Setup

```bash
# Clone repository
git clone <repo-url>
cd mysql-redis-cache/Python

# uv automatically creates and manages virtual environment
uv sync

# Run tests (uv handles venv activation automatically)
uv run pytest

# The virtual environment is created at .venv/ but you don't need to activate it manually
# All uv run commands automatically use the virtual environment
```

## Requirements

- Python 3.13+
- aiomysql
- redis[asyncio]

## License

MIT
