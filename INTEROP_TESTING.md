# End-to-End Interoperability Testing Guide

This document describes how to run comprehensive interoperability tests between the Python and TypeScript implementations of `mysql-redis-cache`.

## Overview

The interoperability tests ensure that:
1. **Cache keys** generated by Python and TypeScript are identical
2. **JSON serialization** formats match exactly between implementations
3. **Data types** (Decimal, DateTime, Boolean, NULL) are handled consistently
4. **Cache entries** written by one implementation can be read by the other
5. **Cache invalidation** works across both implementations

## Prerequisites

### Required Services

1. **Docker** - for running MySQL and Redis
2. **Node.js 18+** - for TypeScript tests
3. **Python 3.13+** - for Python tests
4. **uv** - for Python package management

### Installation

```bash
# Install dependencies
make install

# Or install separately
make install-ts  # TypeScript dependencies
make install-py  # Python dependencies (uses uv)
```

## Test Structure

### Test Files

#### Python Tests

1. **`Python/tests/test_interop_e2e.py`** - End-to-end tests using real MySQL + Redis
   - Tests Python writing and reading from cache
   - Tests cache key generation
   - Tests JSON serialization with real SQL data
   - Tests various MySQL data types (DECIMAL, DATETIME, BOOLEAN, NULL)
   - Tests cache invalidation
   - Tests arbitrary function caching

2. **`Python/tests/test_interop_unit.py`** - Unit tests for interoperability
   - Cache key format validation
   - JSON serialization compatibility
   - Data type conversions

#### TypeScript Tests

1. **`Typescript/tests/interop.test.ts`** - Interoperability tests
   - Tests TypeScript writing cache for Python compatibility
   - Validates cache key generation
   - Tests JSON format (compact, no spaces)
   - Tests data type handling
   - Tests cache invalidation

## Running Tests

### Full Interoperability Test Suite

Runs all interoperability tests for both Python and TypeScript:

```bash
make test-interop
```

This will:
1. Start Docker services (MySQL + Redis)
2. Wait for services to be ready
3. Run TypeScript interoperability tests
4. Run Python interoperability tests
5. Stop Docker services and clean up

### Individual Test Suites

Run only TypeScript or Python tests:

```bash
# TypeScript unit tests only (no Docker needed)
make test-ts

# Python unit tests only (no Docker needed)
make test-py

# TypeScript interop tests (requires Docker)
make test-ts-interop

# All tests in sequence
make test-all
```

### Manual Test Execution

You can also run tests manually for more control:

```bash
# Start Docker services
docker-compose -f redis-compose.yml up -d

# Wait for services to be ready
sleep 10

# Run Python interop E2E tests
cd Python
uv run pytest -m interop -v -s

# Run Python unit tests
uv run pytest -m unit -v

# Run TypeScript interop tests
cd ../Typescript
npm run test:interop

# Stop services
cd ..
docker-compose -f redis-compose.yml down --volumes
```

## Test Coverage

### Cache Key Generation Tests

These tests verify that Python and TypeScript generate identical cache keys:

- Query without parameters → SHA1 hash only
- Query with single parameter → `ParamName=Value_{hash}`
- Query with multiple parameters → `Param1=Val1_Param2=Val2_{hash}`
- Query with string parameters → Proper encoding

**Example:**
```
Query: SELECT * FROM users WHERE id = ?
Params: [123]
Param Names: ['UserId']
Expected Key: UserId=123_{SHA1_hash_of_query}
```

### JSON Serialization Tests

Validates that both implementations produce identical JSON:

- Compact format (no spaces): `[{"id":1,"name":"Alice"}]`
- Nested objects and arrays
- Boolean values: `true`/`false`
- NULL values: `null`
- Number formats (int, float, Decimal → float)

### Data Type Compatibility Tests

Tests MySQL data type handling:

| MySQL Type | Python Type | TypeScript Type | JSON Format |
|------------|-------------|-----------------|-------------|
| INT | int | number | `123` |
| VARCHAR | str | string | `"text"` |
| DECIMAL | Decimal → float | number | `1234.56` |
| DATETIME | datetime → str | Date → string | `"2023-01-15T10:30:00"` |
| DATE | date → str | Date → string | `"1993-06-15"` |
| BOOLEAN | int (0/1) | boolean/number | `0` or `1` |
| NULL | None | null | `null` |

### Cache Operations Tests

- **Write and Read**: Python writes cache, Python reads (baseline)
- **TTL with Jitter**: Verify TTL is set with ±10% jitter
- **Complex Queries**: Multi-row results with all data types
- **NULL Handling**: Ensure NULL values are preserved
- **Arbitrary Functions**: Cache results of non-SQL functions

### Cache Invalidation Tests

- Single parameter invalidation: `drop_outdated_cache(['UserId'], [123])`
- Multiple parameter invalidation: `drop_outdated_cache(['StoreId', 'UserId'], [6, 123])`
- Verify only matching entries are deleted
- Verify other entries remain intact

## Expected Test Output

### Successful Test Run

```
=========================================
Starting E2E Interoperability Test Suite
=========================================

Starting Docker services (MySQL + Redis)...
[+] Running 2/2
 ✔ Container test-redis  Started
 ✔ Container test-mysql  Started

Running TypeScript interoperability tests...
-----------------------------------------
✓ should write cache in format readable by Python
✓ should cache multiple rows with various data types
✓ should handle NULL values correctly
✓ should generate cache keys matching Python format
✓ should verify JSON serialization produces compact format
✓ should cache query with TTL jitter
✓ should invalidate cache entries by parameter

Running Python E2E interoperability tests...
---------------------------------------------
test_e2e_interop.py::TestE2EInteroperability::test_python_writes_cache_structure PASSED
test_e2e_interop.py::TestE2EInteroperability::test_python_reads_python_cache PASSED
test_e2e_interop.py::TestE2EInteroperability::test_cache_key_generation_matches_typescript PASSED
test_e2e_interop.py::TestE2EInteroperability::test_json_serialization_compact_format PASSED
test_e2e_interop.py::TestE2EInteroperability::test_decimal_to_float_conversion PASSED
test_e2e_interop.py::TestE2EInteroperability::test_datetime_serialization PASSED
test_e2e_interop.py::TestE2EInteroperability::test_boolean_values PASSED
test_e2e_interop.py::TestE2EInteroperability::test_null_values PASSED
test_e2e_interop.py::TestE2EInteroperability::test_cache_invalidation_interop PASSED
test_e2e_interop.py::TestE2EInteroperability::test_complex_query_results PASSED
test_e2e_interop.py::TestE2EInteroperability::test_with_cache_arbitrary_function PASSED

=========================================
Interoperability Test Suite Complete
=========================================
```

## Debugging Failed Tests

### Common Issues

1. **Docker services not ready**
   - Increase sleep time in Makefile (default: 10 seconds)
   - Manually verify: `docker ps` and check container status

2. **Port conflicts**
   - Check if ports 3306 (MySQL) or 6379 (Redis) are already in use
   - Modify ports in `redis-compose.yml` if needed

3. **Cache key mismatch**
   - Verify parameter order matches exactly
   - Check query string is identical (including whitespace)
   - Validate SHA1 hash generation

4. **JSON format differences**
   - Ensure Python uses `separators=(',', ':')` and `ensure_ascii=False`
   - Verify TypeScript uses default `JSON.stringify()` (no formatting options)

5. **Data type conversion issues**
   - Check Decimal to float conversion in Python
   - Verify datetime to ISO string conversion
   - Validate NULL handling

### Manual Verification

You can manually inspect cache entries in Redis:

```bash
# Connect to Redis
docker exec -it test-redis redis-cli

# List all keys
KEYS *

# Get a specific cache entry
GET "UserId=123_{hash}"

# Check TTL
TTL "UserId=123_{hash}"

# Exit
exit
```

## CI/CD Integration

For continuous integration, add this to your CI pipeline:

```yaml
# Example GitHub Actions workflow
name: Interoperability Tests

on: [push, pull_request]

jobs:
  test-interop:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
      
      - name: Install uv
        run: pip install uv
      
      - name: Install dependencies
        run: make install
      
      - name: Run interoperability tests
        run: make test-interop
```

## Test Maintenance

### Adding New Tests

When adding features, ensure interoperability by:

1. **Add test to both implementations**
   - Python: `tests/test_e2e_interop.py`
   - TypeScript: `tests/interop.test.ts`

2. **Test both directions**
   - Python writes, verify format
   - TypeScript writes, verify format
   - Ensure both can read each other's data

3. **Document expected behavior**
   - Update this guide
   - Add inline comments in tests

### Updating Test Data

To modify test data in the database:

1. Edit the fixture in `test_e2e_interop.py` (Python) or `beforeAll` in `interop.test.ts` (TypeScript)
2. Ensure data includes all relevant MySQL types
3. Run tests to verify compatibility

## Performance Considerations

- **Test Duration**: Full suite takes ~30-60 seconds (includes Docker startup)
- **Database Setup**: Each test file sets up its own tables
- **Cache Cleanup**: Redis is flushed between test classes
- **Connection Pooling**: MySQL pools are reused within test classes

## Conclusion

The interoperability test suite provides comprehensive validation that Python and TypeScript implementations can work together seamlessly. Run these tests before:

- Publishing new versions
- Making changes to cache key generation
- Modifying JSON serialization
- Updating data type handling
- Deploying to production

For questions or issues, refer to the main [README.md](../README.md) or check the [PYTHON_MIGRATION_PLAN.md](../PYTHON_MIGRATION_PLAN.md).
